SANDBOX ?=
SANDBOX_DIR := ../../sandboxes/$(SANDBOX)

.PHONY: help run stop all check-sandbox

# Default target
help:
	@echo "Red Team Example - Available Commands:"
	@echo ""
	@echo "  make run SANDBOX=<name>"
	@echo "      Run the Red Team attack (starts sandbox and agent0)"
	@echo "  make stop SANDBOX=<name>"
	@echo "      Stop and remove the sandbox and agent0 containers"
	@echo "  make all SANDBOX=<name>"
	@echo "      Clean, then run everything"
	@echo ""
	@echo "  Example: make run SANDBOX=llm_local"
	@echo ""
	@echo "Environment:"
	@echo "  - Sandbox Directory: $(SANDBOX_DIR)"
	@echo ""

check-sandbox:
	@if [ -z "$(SANDBOX)" ]; then \
		echo "Error: SANDBOX is not set."; \
		echo "Usage: make <target> SANDBOX=<name>"; \
		echo "Example: make run SANDBOX=llm_local"; \
		exit 1; \
	fi

run: check-sandbox
	@echo "ðŸš€ Setting up Red Team environment..."
	$(MAKE) -C $(SANDBOX_DIR) build up
	@echo "â³ Waiting for service to be ready..."
	@sleep 5
	@echo "âœ… Environment ready!"
	@echo "Starting agent0 container..."
	@podman pull agent0ai/agent-zero:latest
	# Remove attacker if it already exists to avoid name conflict
	-podman rm -f attacker 2>/dev/null || true
	# Mount settings.json to /a0/tmp/settings.json because agent0 hardcodes it
	# in python/helpers/settings.py:
	# SETTINGS_FILE = files.get_abs_path("tmp/settings.json")
	@podman run -d \
		--name attacker \
		--net sec_test_net \
		-p 50001:80 \
		-v $(CURDIR)/config/settings.json:/a0/tmp/settings.json \
		agent0ai/agent-zero:latest
	@echo "âœ… agent0 started on http://localhost:50001"
	@sleep 10
	@open http://localhost:50001

stop: check-sandbox
	@echo "ðŸ§¹ Tearing down Red Team environment..."
	-podman rm -f attacker 2>/dev/null || true
	$(MAKE) -C $(SANDBOX_DIR) down
	@echo "âœ… Environment cleaned up!"

all: stop run
	@echo ""
	@echo "ðŸ“‹ Example of prompt to be used in agent0:"
	@echo "-------------------------------------------------------------------"
	@cat prompts/OWASP_Top10_LLM_App.md
	@echo "-------------------------------------------------------------------"
